# ğŸ“Š DIAGRAMA VISUAL - ARQUITECTURA SOUL EXPERIENCES

## ğŸ—ºï¸ VISTA GENERAL DEL SISTEMA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (React)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ LandingPage  â”‚  â”‚  AdminPanel  â”‚  â”‚  Components  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                 â”‚                 â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                           â”‚                                         â”‚
â”‚                      API REST (HTTP)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BACKEND (Node.js + Express)                    â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    CAPA 1: CONTROLLERS                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚  â”‚ auth â”‚ â”‚ lead â”‚ â”‚retreatâ”‚ â”‚testi-â”‚ â”‚token â”‚ â”‚settingâ”‚     â”‚ â”‚
â”‚  â”‚  â”‚      â”‚ â”‚      â”‚ â”‚       â”‚ â”‚monialâ”‚ â”‚      â”‚ â”‚       â”‚     â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚        â”‚        â”‚         â”‚        â”‚        â”‚           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    CAPA 2: SERVICES                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â”‚  â”‚ user â”‚ â”‚ lead â”‚ â”‚retreatâ”‚ â”‚testi-â”‚ â”‚token â”‚ â”‚email â”‚      â”‚ â”‚
â”‚  â”‚  â”‚Serviceâ”‚ â”‚Serviceâ”‚ â”‚Serviceâ”‚ â”‚monialâ”‚ â”‚Serviceâ”‚ â”‚Serviceâ”‚      â”‚ â”‚
â”‚  â”‚  â”‚      â”‚ â”‚      â”‚ â”‚       â”‚ â”‚Serviceâ”‚ â”‚      â”‚ â”‚      â”‚      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚        â”‚        â”‚         â”‚        â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    CAPA 3: MODELS                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚  â”‚ User â”‚ â”‚ Lead â”‚ â”‚Retreatâ”‚ â”‚Testi-â”‚ â”‚Token â”‚ â”‚Settingâ”‚     â”‚ â”‚
â”‚  â”‚  â”‚      â”‚ â”‚      â”‚ â”‚       â”‚ â”‚monialâ”‚ â”‚      â”‚ â”‚       â”‚     â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚        â”‚         â”‚        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MONGODB (Base de Datos)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  users   â”‚ â”‚  leads   â”‚ â”‚ retreats â”‚ â”‚testimonialsâ”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  â”‚  tokens  â”‚ â”‚ settings â”‚                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— RELACIONES ENTRE COLECCIONES

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     RETREAT     â”‚
                    â”‚   (Retiro)      â”‚
                    â”‚                 â”‚
                    â”‚ â€¢ title         â”‚
                    â”‚ â€¢ dates         â”‚
                    â”‚ â€¢ price         â”‚
                    â”‚ â€¢ capacity      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚            â”‚            â”‚
                â”‚ 1:N        â”‚ 1:N        â”‚ 1:N
                â”‚            â”‚            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     LEAD     â”‚ â”‚TESTIMONIAL â”‚ â”‚TESTIMONIAL    â”‚
        â”‚  (Consulta)  â”‚ â”‚(Testimonio)â”‚ â”‚    TOKEN      â”‚
        â”‚              â”‚ â”‚            â”‚ â”‚               â”‚
        â”‚ â€¢ name       â”‚ â”‚ â€¢ rating   â”‚ â”‚ â€¢ token       â”‚
        â”‚ â€¢ email      â”‚ â”‚ â€¢ comment  â”‚ â”‚ â€¢ isUsed      â”‚
        â”‚ â€¢ status     â”‚ â”‚ â€¢ approved â”‚ â”‚ â€¢ expiresAt   â”‚
        â”‚ â€¢ payment    â”‚ â”‚ â€¢ featured â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚
                                â”‚               â”‚
                                â”‚ 1:1 opcional  â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    USER     â”‚              â”‚   SETTING   â”‚
    â”‚   (Admin)   â”‚              â”‚   (Config)  â”‚
    â”‚             â”‚              â”‚             â”‚
    â”‚ â€¢ name      â”‚              â”‚ â€¢ facilitatorâ”‚
    â”‚ â€¢ email     â”‚              â”‚ â€¢ contact   â”‚
    â”‚ â€¢ password  â”‚              â”‚ â€¢ theme     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    (Independiente)               (Singleton)
```

---

## ğŸ¯ FLUJO DE DATOS: CREAR LEAD

```
1. USUARIO (Landing)
   â”‚
   â”‚ POST /api/leads
   â”‚ { name, email, phone, retreat }
   â”‚
   â–¼
2. leadController.createLead()
   â”‚
   â”‚ Llama a â†’
   â”‚
   â–¼
3. leadService.createLead()
   â”‚
   â”œâ”€â†’ Verifica retiro existe (Retreat.findOne)
   â”œâ”€â†’ Verifica disponibilidad (Lead.countDocuments)
   â”œâ”€â†’ Verifica duplicado (Lead.findOne)
   â”‚
   â”‚ Lead.create()
   â”‚
   â–¼
4. MongoDB: Inserta en colecciÃ³n 'leads'
   â”‚
   â”‚ Response
   â”‚
   â–¼
5. Usuario recibe confirmaciÃ³n
```

---

## ğŸ”„ FLUJO DE DATOS: ACTUALIZAR LEAD (Confirmar Pago)

```
1. ADMIN (Panel)
   â”‚
   â”‚ PUT /api/leads/:id
   â”‚ { status: 'confirmado', paymentStatus: 'completo' }
   â”‚
   â–¼
2. leadController.updateLead()
   â”‚
   â”‚ Llama a â†’
   â”‚
   â–¼
3. leadService.updateLead()
   â”‚
   â”œâ”€â†’ Lead.findById() - Obtiene lead actual
   â”‚   â€¢ Estaba confirmado? NO (seÃ±a != completo)
   â”‚
   â”œâ”€â†’ Lead.findByIdAndUpdate() - Actualiza
   â”‚   â€¢ status: 'confirmado'
   â”‚   â€¢ paymentStatus: 'completo'
   â”‚   â€¢ confirmedAt: new Date()
   â”‚
   â”œâ”€â†’ Verifica nuevo estado
   â”‚   â€¢ EstÃ¡ confirmado ahora? SÃ
   â”‚
   â””â”€â†’ Detecta cambio: availabilityChanged = true
   â”‚
   â–¼
4. MongoDB: Actualiza documento en 'leads'
   â”‚
   â–¼
5. PrÃ³xima consulta a Retreat:
   â”‚
   â”‚ retreatService.enrichRetreatWithParticipants()
   â”‚
   â”œâ”€â†’ Lead.countDocuments({
   â”‚     retreat: id,
   â”‚     status: 'confirmado',
   â”‚     paymentStatus: 'completo'
   â”‚   })
   â”‚
   â””â”€â†’ Calcula:
       â€¢ currentParticipants = count
       â€¢ availableSpots = max - count
       â€¢ isFull = count >= max
```

---

## ğŸ“Š CÃLCULO DE DISPONIBILIDAD

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Â¿CÃ³mo se calcula la disponibilidad de un retiro?      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âŒ NO HAY campo 'currentParticipants' en Retreat schema
âœ… SE CALCULA dinÃ¡micamente cada vez que se consulta

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  retreatService.enrichRetreatWithParticipants()      â”‚
â”‚                                                      â”‚
â”‚  1. Cuenta leads confirmados:                       â”‚
â”‚     const count = await Lead.countDocuments({       â”‚
â”‚       retreat: retreatId,                           â”‚
â”‚       status: 'confirmado',                         â”‚
â”‚       paymentStatus: 'completo'                     â”‚
â”‚     });                                             â”‚
â”‚                                                      â”‚
â”‚  2. Calcula disponibilidad:                         â”‚
â”‚     currentParticipants = count                     â”‚
â”‚     availableSpots = maxParticipants - count        â”‚
â”‚     isFull = count >= maxParticipants               â”‚
â”‚                                                      â”‚
â”‚  3. Retorna retiro enriquecido                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VENTAJAS:
âœ… Siempre preciso (no hay desincronizaciÃ³n)
âœ… No requiere actualizar campo en BD
âœ… Menos propenso a errores
âœ… Un solo lugar de verdad (colecciÃ³n leads)
```

---

## ğŸ” FLUJO DE AUTENTICACIÃ“N

```
1. ADMIN (Login)
   â”‚
   â”‚ POST /api/auth/login
   â”‚ { email, password }
   â”‚
   â–¼
2. authController.login()
   â”‚
   â”‚ Llama a â†’
   â”‚
   â–¼
3. userService.authenticateUser()
   â”‚
   â”œâ”€â†’ User.findOne({ email }).select('+password')
   â”œâ”€â†’ user.comparePassword(password) - bcrypt
   â”œâ”€â†’ user.generateAuthToken() - JWT
   â”‚
   â””â”€â†’ { token, user }
   â”‚
   â–¼
4. Admin recibe token JWT
   â”‚
   â”‚ Guarda en localStorage
   â”‚
   â–¼
5. Peticiones futuras incluyen:
   â”‚
   â”‚ Headers: { Authorization: 'Bearer <token>' }
   â”‚
   â–¼
6. Middleware: protect()
   â”‚
   â”œâ”€â†’ Verifica token JWT
   â”œâ”€â†’ Decodifica payload
   â”œâ”€â†’ Busca usuario
   â”‚
   â””â”€â†’ req.user = usuario
   â”‚
   â–¼
7. Controller tiene acceso a req.user
```

---

## ğŸ« FLUJO DE TOKENS DE TESTIMONIO

```
1. ADMIN (Panel)
   â”‚
   â”‚ POST /api/tokens/generate/:retreatId
   â”‚ { quantity: 5 }
   â”‚
   â–¼
2. tokenController.generateTokensForRetreat()
   â”‚
   â–¼
3. tokenService.generateTokensForRetreat()
   â”‚
   â”œâ”€â†’ Retreat.findById() - Verifica retiro
   â”œâ”€â†’ Lead.find({ retreat, status: 'confirmado' })
   â”œâ”€â†’ TestimonialToken.find({ retreat }) - Tokens existentes
   â”‚
   â”œâ”€â†’ Filtra participantes sin token
   â”‚
   â”œâ”€â†’ TestimonialToken.generateForRetreat()
   â”‚   â””â”€â†’ Crea tokens con crypto.randomBytes(32)
   â”‚
   â””â”€â†’ emailService.sendTestimonialToken()
       â””â”€â†’ EnvÃ­a email con link Ãºnico
   â”‚
   â–¼
4. MongoDB: Inserta en 'testimonialTokens'
   â”‚
   â–¼
5. PARTICIPANTE recibe email
   â”‚
   â”‚ Click en link: /testimonial/:token
   â”‚
   â–¼
6. FRONTEND valida token
   â”‚
   â”‚ GET /api/tokens/validate/:token
   â”‚
   â–¼
7. tokenService.validatePublicToken()
   â”‚
   â”œâ”€â†’ TestimonialToken.validateToken()
   â”‚   â€¢ isUsed = false
   â”‚   â€¢ expiresAt > now
   â”‚
   â””â”€â†’ { participantName, retreat, expiresAt }
   â”‚
   â–¼
8. PARTICIPANTE completa formulario
   â”‚
   â”‚ POST /api/testimonials/submit/:token
   â”‚ { rating, comment }
   â”‚
   â–¼
9. testimonialService.submitTestimonialWithToken()
   â”‚
   â”œâ”€â†’ Valida token nuevamente
   â”œâ”€â†’ Testimonial.create()
   â”œâ”€â†’ token.isUsed = true
   â”œâ”€â†’ token.testimonial = testimonialId
   â”‚
   â–¼
10. MongoDB: Inserta en 'testimonials'
    â”‚
    â–¼
11. ADMIN revisa y aprueba
    â”‚
    â”‚ PUT /api/testimonials/:id
    â”‚ { isApproved: true, isFeatured: true }
    â”‚
    â–¼
12. Aparece en landing page
```

---

## ğŸ“‹ ENUMS CENTRALIZADOS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           backend/constants/enums.js                    â”‚
â”‚                                                         â”‚
â”‚  export const LEAD_STATUS = {                          â”‚
â”‚    NUEVO: 'nuevo',                                     â”‚
â”‚    CONTACTADO: 'contactado',                           â”‚
â”‚    INTERESADO: 'interesado',                           â”‚
â”‚    CONFIRMADO: 'confirmado',                           â”‚
â”‚    DESCARTADO: 'descartado'                            â”‚
â”‚  };                                                     â”‚
â”‚                                                         â”‚
â”‚  export const PAYMENT_STATUS = { ... }                 â”‚
â”‚  export const PAYMENT_METHOD = { ... }                 â”‚
â”‚  export const RETREAT_STATUS = { ... }                 â”‚
â”‚  export const CURRENCY = { ... }                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ Importado por
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
        â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Lead.js    â”‚  â”‚  Retreat.js  â”‚  â”‚leadService.jsâ”‚
â”‚              â”‚  â”‚              â”‚  â”‚              â”‚
â”‚ enum:        â”‚  â”‚ enum:        â”‚  â”‚ Usa para     â”‚
â”‚ LEAD_STATUS_ â”‚  â”‚ RETREAT_     â”‚  â”‚ validaciones â”‚
â”‚ ARRAY        â”‚  â”‚ STATUS_ARRAY â”‚  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         frontend/src/constants/enums.js                 â”‚
â”‚                                                         â”‚
â”‚  export const LEAD_STATUS_OPTIONS = [                  â”‚
â”‚    { value: 'nuevo', label: 'Nuevo' },                â”‚
â”‚    { value: 'contactado', label: 'Contactado' },      â”‚
â”‚    ...                                                 â”‚
â”‚  ];                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ Usado por
                          â”‚
                          â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚LeadDetail.jsxâ”‚
                  â”‚              â”‚
                  â”‚ Dropdowns    â”‚
                  â”‚ con opciones â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ RESUMEN VISUAL DE COHERENCIA

```
âœ… COHERENTE                    âš ï¸ MEJORABLE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Arquitectura   â”‚           â”‚ â€¢ settingCtrl    â”‚
â”‚   3 capas        â”‚           â”‚   sin service    â”‚
â”‚                  â”‚           â”‚   (aceptable)    â”‚
â”‚ â€¢ Enums en       â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   Lead.js âœ…     â”‚
â”‚                  â”‚           âŒ CORREGIDO
â”‚ â€¢ Enums en       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Retreat.js âœ…  â”‚           â”‚ â€¢ Retreat.js     â”‚
â”‚   (CORREGIDO)    â”‚           â”‚   ahora usa      â”‚
â”‚                  â”‚           â”‚   enums âœ…       â”‚
â”‚ â€¢ Disponibilidad â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   dinÃ¡mica âœ…    â”‚
â”‚                  â”‚
â”‚ â€¢ Relaciones     â”‚
â”‚   bien definidas â”‚
â”‚                  â”‚
â”‚ â€¢ Services con   â”‚
â”‚   lÃ³gica clara   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ† MÃ‰TRICAS FINALES

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ESTADO DEL SISTEMA              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Modelos:              6                 â”‚
â”‚ Controllers:          6                 â”‚
â”‚ Services:             6                 â”‚
â”‚ Enums sincronizados:  7/7 âœ…           â”‚
â”‚ Relaciones:           4 (bien definidas)â”‚
â”‚ Ãndices:              ~30               â”‚
â”‚ Inconsistencias:      0 âœ…              â”‚
â”‚                                         â”‚
â”‚ CALIFICACIÃ“N:    ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ           â”‚
â”‚                  EXCELENTE              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Generado**: 2025-10-12  
**Sistema**: Soul Experiences  
**Estado**: âœ… ProducciÃ³n Ready
