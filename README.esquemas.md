# Esquemas de Modelos - Soul Experiences

Este documento complementa al `README.md` principal y resume los modelos de la base de datos utilizando tablas que facilitan la consulta r√°pida de campos, validaciones, virtuales, √≠ndices y relaciones.

> **Nota**: Toda la informaci√≥n proviene directamente de los archivos en `backend/models` y `backend/constants/enums.js`. Cuando existan cambios en los modelos, actualizar este archivo en conjunto con el README principal.

---

## üìÅ Modelos de Mongoose

### 1. Retreat (`backend/models/Retreat.js`)

| Campo | Tipo | Req. | Descripci√≥n | Notas |
|-------|------|------|-------------|-------|
| `title` | `String` | ‚úÖ | T√≠tulo del retiro (m√°x. 100) | Se usa para generar `slug`
| `description` | `String` | ‚úÖ | Descripci√≥n detallada (m√°x. 2000) |  |
| `shortDescription` | `String` | ‚ùå | Resumen (m√°x. 300) |  |
| `targetAudience` | `[String]` | ‚ùå | P√∫blico objetivo |  |
| `experiences` | `[String]` | ‚ùå | Actividades incluidas |  |
| `startDate` | `Date` | ‚úÖ | Inicio del retiro |  |
| `endDate` | `Date` | ‚úÖ | Fin del retiro (`>= startDate`) | Validaci√≥n de rango
| `location` | `Object` | ‚úÖ | Datos completos del lugar | Ver tabla anidada
| `price` | `Number` | ‚úÖ | Precio base (`>= 0`) |  |
| `currency` | `String` | ‚úÖ | Moneda (`ARS`/`USD`/`EUR`) | Default: `ARS`
| `pricingTiers` | `[Object]` | ‚ùå | Escalas de precio | Validaci√≥n personalizada
| `maxParticipants` | `Number` | ‚úÖ | Cupos (1-100) |  |
| `includes` | `[String]` | ‚ùå | √çtems incluidos |  |
| `notIncludes` | `[String]` | ‚ùå | √çtems excluidos |  |
| `foodInfo` | `Object` | ‚ùå | Informaci√≥n de alimentaci√≥n |  |
| `policies` | `Object` | ‚ùå | Pol√≠ticas y restricciones |  |
| `images` | `[String]` | ‚ùå | URLs de im√°genes |  |
| `heroImageIndex` | `Number` | ‚ùå | √çndice hero (>=0) | Valida rango seg√∫n `images`
| `highlightWords` | `[String]` | ‚ùå | Palabras destacadas |  |
| `showInHero` | `Boolean` | ‚ùå | Mostrar en hero | Default: `false`
| `status` | `String` | ‚úÖ | Estado (`draft`/`active`/`completed`/`cancelled`) | Default: `draft`
| `slug` | `String` | ‚úÖ | Slug √∫nico | Generado en `pre('validate')`
| `whatsappNumber` | `String` | ‚ùå | Contacto espec√≠fico |  |
| `createdAt` / `updatedAt` | `Date` | ‚úÖ | Timestamps | `timestamps: true`

**Subdocumento `location`**

| Campo | Tipo | Req. | Descripci√≥n |
|-------|------|------|-------------|
| `name` | `String` | ‚úÖ | Nombre del lugar |
| `address` | `String` | ‚úÖ | Direcci√≥n f√≠sica |
| `city` / `state` / `country` | `String` | ‚ùå | Ubicaci√≥n geogr√°fica (Default pa√≠s: Argentina) |
| `description` | `String` | ‚ùå | Texto descriptivo |
| `features` | `[String]` | ‚ùå | Caracter√≠sticas destacadas |
| `accommodationType` | `String` | ‚ùå | Tipo de alojamiento |
| `howToGetThere` | `Object` | ‚ùå | Instrucciones de acceso |

**Subdocumento `pricingTiers`**

| Campo | Tipo | Req. | Descripci√≥n |
|-------|------|------|-------------|
| `name` | `String` | ‚úÖ | T√≠tulo de la escala |
| `price` | `Number` | ‚úÖ | Precio con descuento |
| `validUntil` | `Date` | ‚úÖ | Fecha l√≠mite |
| `paymentOptions` | `[String]` | ‚ùå | Opciones de pago |

**Virtuales**
- `durationDays`: Duraci√≥n en d√≠as (`endDate - startDate`).
- `availableSpots`: Cupos disponibles (`maxParticipants - confirmed`).
- `computedStatus`: Ajusta estado seg√∫n fechas y cupos.
- `effectivePrice`: Determina precio vigente (tier activo o base).
- `activePricingTier`: Devuelve el tier actual.

**√çndices & Middleware**
- √çndice √∫nico en `slug`.
- `pre('save')`: genera slug y normaliza datos.

---

### 2. Testimonial (`backend/models/Testimonial.js`)

| Campo | Tipo | Req. | Descripci√≥n | Notas |
|-------|------|------|-------------|-------|
| `participantName` | `String` | ‚úÖ | Nombre de quien opina |  |
| `participantEmail` | `String` | ‚ùå | Email de contacto | Lowercase
| `participantPhoto` | `String` | ‚ùå | URL de foto |  |
| `retreat` | `ObjectId` | ‚úÖ | Referencia a `Retreat` | `ref: 'Retreat'`
| `rating` | `Number` | ‚úÖ | Puntaje 1-5 | Validaci√≥n de rango
| `comment` | `String` | ‚úÖ | Texto del testimonio |  |
| `isApproved` | `Boolean` | ‚úÖ | Aprobado o no | Default `false`
| `isFeatured` | `Boolean` | ‚úÖ | Mostrar en landing | Default `false`
| `token` | `String` | ‚ùå | Token utilizado | √önico cuando existe
| `approvedAt` | `Date` | ‚ùå | Fecha de aprobaci√≥n | Auto-set en middleware
| `notes` | `String` | ‚ùå | Notas internas (m√°x. 1000) |  |
| `createdBy` | `ObjectId` | ‚ùå | Usuario que cre√≥ el testimonio |  |
| `createdAt` / `updatedAt` | `Date` | ‚úÖ | Timestamps | `timestamps: true`

**Virtuales**
- `stars`: Devuelve array de longitud `rating` para UI.

**Middleware**
- `pre('save')`: setea `approvedAt` cuando `isApproved` pasa a `true`.

**√çndices**
- `retreat` (para consultas).
- `isApproved`, `isFeatured` (filtrado r√°pido).

---

### 3. Lead (`backend/models/Lead.js`)

| Campo | Tipo | Req. | Descripci√≥n | Notas |
|-------|------|------|-------------|-------|
| `name` | `String` | ‚úÖ | Nombre del interesado | M√°x. 120 |
| `email` | `String` | ‚úÖ | Email en min√∫sculas | Validaci√≥n de formato |
| `phone` | `String` | ‚ùå | Tel√©fono de contacto |  |
| `retreat` | `ObjectId` | ‚ùå | Referencia a `Retreat` | Permite `null`
| `message` | `String` | ‚ùå | Mensaje enviado | M√°x. 1000 |
| `status` | `String` | ‚úÖ | Estado (`nuevo`, `contactado`, `interesado`, `confirmado`, `descartado`) | Default: `nuevo`
| `interest` | `String` | ‚úÖ | Intenci√≥n (`reservar`, `info`, `consulta`) | Default: `info`
| `paymentStatus` | `String` | ‚úÖ | Pago (`pendiente`, `se√±a`, `completo`) | Default: `pendiente`
| `paymentAmount` | `Number` | ‚ùå | Monto abonado (`>=0`) |  |
| `paymentMethod` | `String` | ‚ùå | M√©todo (`transferencia`, `mercadopago`, `efectivo`) | Default: `""`
| `notes` | `String` | ‚ùå | Notas internas (m√°x. 1000) |  |
| `source` | `String` | ‚úÖ | Origen (`landing`, `instagram`, `facebook`, `referido`, `otro`) | Default: `landing`
| `contactedAt` | `Date` | ‚ùå | Fecha de contacto |  |
| `confirmedAt` | `Date` | ‚ùå | Fecha de confirmaci√≥n |  |
| `createdAt` / `updatedAt` | `Date` | ‚úÖ | Timestamps |  |

**Virtuales**
- `isConfirmed`: `status === 'confirmado' && paymentStatus === 'completo'`.

**√çndices**
- √çndice √∫nico compuesto `{ email, retreat }` con `partialFilterExpression` para evitar duplicados por retiro.

---

### 4. User (`backend/models/User.js`)

| Campo | Tipo | Req. | Descripci√≥n | Notas |
|-------|------|------|-------------|-------|
| `name` | `String` | ‚úÖ | Nombre completo | M√°x. 100 |
| `email` | `String` | ‚úÖ | Email √∫nico/select false | Lowercase, trim |
| `password` | `String` | ‚úÖ | Hash bcrypt (12 salt rounds) | `select: false`
| `role` | `String` | ‚úÖ | Rol (`admin`, `editor`) | Default: `admin`
| `lastLogin` | `Date` | ‚ùå | √öltimo acceso |  |
| `passwordChangedAt` | `Date` | ‚ùå | √öltimo cambio | Actualiza JWT validity
| `createdAt` / `updatedAt` | `Date` | ‚úÖ | Timestamps |  |

**Middleware**
- `pre('save')`: hashea password si es nuevo o modificado.
- `pre('save')`: setea `passwordChangedAt` cuando se actualiza la contrase√±a.

**M√©todos de instancia**
- `comparePassword(plain)`: compara usando bcrypt.
- `generateAuthToken()`: genera JWT con expiraci√≥n y payload `{ id, email, role }`.

**Est√°ticos**
- `createDefaultAdmin()`: crea admin inicial si no existe.

---

### 5. Setting (`backend/models/Setting.js`) ‚Äì *Singleton*

| Campo | Tipo | Req. | Descripci√≥n | Notas |
|-------|------|------|-------------|-------|
| `facilitatorName` | `String` | ‚úÖ | Nombre del facilitador (m√°x. 100) |  |
| `facilitatorBio` | `String` | ‚ùå | Biograf√≠a (m√°x. 1000) |  |
| `facilitatorPhoto` | `String` | ‚ùå | URL de la foto |  |
| `contactEmail` | `String` | ‚úÖ | Email de contacto v√°lido |  |
| `whatsappNumber` | `String` | ‚úÖ | N√∫mero visible en landing |  |
| `socialMedia` | `Object` | ‚ùå | Redes: `instagram`, `facebook`, `youtube`, `website` |  |
| `siteTitle` | `String` | ‚ùå | T√≠tulo principal (m√°x. 100) | Default: `Retiros Espirituales`
| `siteDescription` | `String` | ‚ùå | Descripci√≥n corta (m√°x. 200) |  |
| `siteLogo` | `String` | ‚ùå | URL del logo |  |
| `emailSettings` | `Object` | ‚ùå | `fromName`, `fromEmail`, `replyTo` |  |
| `customTexts` | `Object` | ‚ùå | Textos hero, CTA, agradecimiento | Defaults definidos |
| `theme` | `Object` | ‚ùå | Colores primario/secundario/acento | Defaults definidos |
| `isActive` | `Boolean` | ‚úÖ | Indica configuraci√≥n vigente | Default: `true`
| `createdAt` / `updatedAt` | `Date` | ‚úÖ | Timestamps |  |

**√çndices**
- √çndice √∫nico parcial `{ isActive: 1 }` para garantizar un solo registro activo.

**Est√°ticos**
- `getActive()`: retorna config activa (crea una por defecto si no existe).
- `createDefault(facilitatorData)`: inicializa valores b√°sicos.

---

### 6. TestimonialToken (`backend/models/TestimonialToken.js`)

| Campo | Tipo | Req. | Descripci√≥n | Notas |
|-------|------|------|-------------|-------|
| `token` | `String` | ‚úÖ | Token √∫nico (hex 64) | √çndice √∫nico |
| `email` | `String` | ‚úÖ | Email del participante | Lowercase |
| `participantName` | `String` | ‚úÖ | Nombre del invitado |  |
| `retreat` | `ObjectId` | ‚úÖ | Referencia al retiro | `ref: 'Retreat'`
| `isUsed` | `Boolean` | ‚úÖ | Si fue utilizado | Default: `false`
| `usedAt` | `Date` | ‚ùå | Fecha de uso | Auto-set en middleware
| `expiresAt` | `Date` | ‚úÖ | Caducidad (30 d√≠as) | TTL index
| `testimonial` | `ObjectId` | ‚ùå | Testimonio creado (ref `Testimonial`) |  |
| `createdAt` / `updatedAt` | `Date` | ‚úÖ | Timestamps |  |

**Virtuales**
- `isExpired`: `Date.now() > expiresAt`.
- `isValid`: `!isUsed && !isExpired`.

**Middleware**
- `pre('save')`: setea `usedAt` cuando `isUsed` pasa a `true`.

**√çndices**
- √önico en `token`.
- √çndice compuesto `{ email, retreat }` para evitar duplicados.
- TTL index en `expiresAt` para eliminaci√≥n autom√°tica.

**Est√°ticos**
- `generateForRetreat(retreatId, participants)`: crea tokens masivos.
- `validateToken(token)`: retorna token v√°lido con `populate('retreat')`.

---

## üîÅ Enums y Constantes Compartidas (`backend/constants/enums.js`)

| Enum | Valores |
|------|---------|
| `LEAD_STATUS` | `nuevo`, `contactado`, `interesado`, `confirmado`, `descartado` |
| `PAYMENT_STATUS` | `pendiente`, `se√±a`, `completo` |
| `PAYMENT_METHOD` | `transferencia`, `mercadopago`, `efectivo` |
| `INTEREST_TYPE` | `reservar`, `info`, `consulta` |
| `LEAD_SOURCE` | `landing`, `instagram`, `facebook`, `referido`, `otro` |
| `RETREAT_STATUS` | `draft`, `active`, `completed`, `cancelled` |
| `CURRENCY` | `ARS`, `USD`, `EUR` |

> **Frontend sincronizado**: `frontend/src/constants/enums.js` reproduce estos valores para selectores y validaciones en la UI.

---

## üîí Relaciones y Populate

| Relaci√≥n | Descripci√≥n | Uso |
|----------|-------------|-----|
| `Testimonial.retreat` | Cada testimonio pertenece a un retiro | `Testimonial.find().populate('retreat')` |
| `Lead.retreat` | Leads asociados a retiros | `Lead.find().populate('retreat')` |
| `TestimonialToken.retreat` | Tokens generados por retiro | `TestimonialToken.find().populate('retreat')` |
| `TestimonialToken.testimonial` | Vincula token con testimonio creado | Populate opcional en panel admin |

---

## ‚úÖ Resumen

- Este documento provee una visi√≥n orientada a esquemas/tablas ideal para presentar el modelo de datos.
- El README principal mantiene explicaciones narrativas, diagramas y ejemplos de uso.
- Ambos documentos deben mantenerse sincronizados frente a cambios futuros.
